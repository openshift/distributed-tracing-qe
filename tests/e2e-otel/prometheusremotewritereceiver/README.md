# OpenTelemetry Prometheus Remote Write Receiver Test

This test demonstrates the OpenTelemetry Prometheus Remote Write receiver configuration for receiving metrics using the Remote Write v2.0 protocol from another OpenTelemetry Collector using the Prometheus Remote Write exporter. Metrics are generated by telemetrygen and ingested by the sender collector via OTLP, which then forwards them via Prometheus Remote Write v2 to the receiver collector.

## üéØ What This Test Does

The test validates that the Prometheus Remote Write receiver can:
- Receive metrics via Prometheus Remote Write v2.0 from another OpenTelemetry Collector
- Convert Prometheus remote write data to OpenTelemetry format
- Forward received metrics through the OpenTelemetry pipeline (debug exporter)
- Operate without a Prometheus MonitoringStack deployment

## üìã Test Resources

The test uses the following key resources that are included in this directory:

### 1. OpenTelemetry Receiver Collector
- **File**: [`otel-collector-receiver.yaml`](./otel-collector-receiver.yaml)
- **Contains**: OpenTelemetryCollector with Prometheus Remote Write receiver
- **Key Features**:
  - Prometheus remote write receiver listening on port 9090
  - Debug exporter with detailed verbosity for metric verification
  - Batch processor for efficient metric handling
  - Endpoint configured to accept remote write v2 protocol

### 2. OpenTelemetry Sender Collector
- **File**: [`otel-collector-sender.yaml`](./otel-collector-sender.yaml)
- **Contains**: OpenTelemetryCollector with OTLP receiver and Prometheus Remote Write exporter (v2)
- **Key Features**:
  - Receives metrics via OTLP from telemetrygen
  - Exports metrics to the receiver using Prometheus Remote Write v2
  - Enables RW v2 via feature gate and v2 protobuf message
  - Uses the contrib collector image version `0.142.0`

### 3. Metrics Generator
- **File**: [`generate-metrics.yaml`](./generate-metrics.yaml)
- **Contains**: telemetrygen Job that sends OTLP metrics to the sender collector
- **Key Features**:
  - Generates test metrics using telemetrygen
  - Targets `otel-sender-collector:4317` (OTLP gRPC)

### 4. Metrics Verification
- **File**: [`check-metrics.yaml`](./check-metrics.yaml)
- **Contains**: Job for verifying metrics received by the receiver collector
- **Key Features**:
  - Searches receiver collector logs for telemetrygen attributes and ResourceMetrics
  - Confirms Remote Write v2 protocol functionality
  - Verifies no protocol version errors or client failures

### 5. Chainsaw Test Definition
- **File**: [`chainsaw-test.yaml`](./chainsaw-test.yaml)
- **Contains**: Complete test workflow orchestration
- **Includes**: Test steps for collector deployment, Prometheus setup, and verification

## üöÄ Test Steps

The test follows this sequence as defined in [`chainsaw-test.yaml`](./chainsaw-test.yaml):

1. **Deploy Receiver Collector** - Deploy from [`otel-collector-receiver.yaml`](./otel-collector-receiver.yaml)
2. **Deploy Sender Collector** - Deploy from [`otel-collector-sender.yaml`](./otel-collector-sender.yaml)
3. **Setup RBAC** - Configure permissions for verification job
4. **Generate Metrics** - Run telemetrygen from [`generate-metrics.yaml`](./generate-metrics.yaml)
5. **Verify Metrics Reception** - Execute from [`check-metrics.yaml`](./check-metrics.yaml)

## üîç Remote Write v2 Configuration

### OpenTelemetry Receiver Configuration:
- **Endpoint**: `0.0.0.0:9090` - accepts remote write requests
- **Protocol**: **Prometheus Remote Write v2** (exclusive support)
- **Processing**: Routes received metrics to debug exporter with detailed logging
- **Service**: Exposed via Kubernetes service on port 9090

### Sender Collector Prometheus Remote Write (v2) Configuration:
- **Target Endpoint**: `http://otel-receiver-collector:9090/api/v1/write`
- **Protocol**: Prometheus Remote Write v2 (enabled via feature gate + v2 protobuf)
- **Collector Image**: `opentelemetry-collector-contrib:0.144.0`

### Simplified Architecture:
```
[telemetrygen] --OTLP--> [otel-sender-collector] --Prometheus Remote Write v2--> [otel-receiver-collector] -> [debug logs]
```

### ‚úÖ Protocol Compatibility:
This test uses the OpenTelemetry Collector prometheusremotewrite exporter to send metrics using Remote Write v2 to the receiver. The receiver supports only v2. The sender is configured to:
- Enable the feature gate: `exporter.prometheusremotewritexporter.enableSendingRW2`
- Use the v2 protobuf: `protobuf_message: "io.prometheus.write.v2.Request"`

Key benefits of this approach:
- ‚úÖ Native Remote Write v2 protocol implementation
- ‚úÖ Full compatibility with prometheusremotewritereceiver
- ‚úÖ Direct testing without Prometheus MonitoringStack complexity
- ‚úÖ Configurable load and realistic metric generation
- ‚úÖ Fast, focused test execution
- ‚úÖ Easy debugging and troubleshooting

## üîç Verification

The verification is handled by [`check-metrics.yaml`](./check-metrics.yaml), which:
- Searches OpenTelemetry receiver collector logs for telemetrygen metrics
- Confirms Remote Write v2 protocol functionality (no version rejection errors)
- Verifies that metrics appear in the debug exporter output with proper processing
- Provides detailed success/failure reporting with sample metric data

## üìù Key Configuration Notes

### Remote Write v2 Protocol Support
- Uses Remote Write v2 protocol exclusively (v1 not supported by receiver)
- Supports Native Histograms with atomic transmission
- Handles metadata and metrics in coupled requests

### Security Considerations
- Uses HTTP for internal cluster communication
- Service-to-service communication within Kubernetes cluster
- No external network exposure required

## üßπ Cleanup

The test runs in the default namespace and all resources are cleaned up automatically when the test completes.

## üîó Related Components

This test complements the [`prometheusremotewriteexporter`](../prometheusremotewriteexporter/) test by demonstrating the receiving side of the Prometheus Remote Write v2 protocol in OpenTelemetry deployments using a sender collector.