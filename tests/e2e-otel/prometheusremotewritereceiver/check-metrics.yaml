apiVersion: batch/v1
kind: Job
metadata:
  name: check-remote-write-v2-metrics
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: check-metrics
        image: bitnami/kubectl:latest
        command: ["/bin/bash"]
        args:
        - -c
        - |
          set -e
          echo "üîç Checking OpenTelemetry receiver collector logs for metrics received via Remote Write v2..."

          # Wait a moment for logs to be available
          sleep 10

          # Get the receiver collector pod name
          COLLECTOR_POD=$(kubectl get pods -o name | grep '^pod/otel-receiver-collector' | head -n1 | cut -d/ -f2)

          if [ -z "$COLLECTOR_POD" ]; then
            echo "‚ùå Could not find OpenTelemetry collector pod"
            exit 1
          fi

          echo "üìã Found collector pod: $COLLECTOR_POD"
          echo ""

          # Check for telemetrygen metrics in logs
          echo "üîé Searching for telemetrygen metrics arriving via Remote Write v2..."

          # Look for specific metrics generated by our client
          METRICS_FOUND=0

          echo "  ‚û§ Checking for telemetrygen resource attribute..."
          if kubectl logs "$COLLECTOR_POD" | grep -qi "telemetrygen"; then
            echo "    ‚úÖ Found telemetrygen attribute in metrics"
            METRICS_FOUND=$((METRICS_FOUND + 1))
          else
            echo "    ‚ùå telemetrygen attribute not found"
          fi

          echo "  ‚û§ Checking for ResourceMetrics blocks..."
          if kubectl logs "$COLLECTOR_POD" | grep -q "ResourceMetrics"; then
            echo "    ‚úÖ Found ResourceMetrics entries"
            METRICS_FOUND=$((METRICS_FOUND + 1))
          else
            echo "    ‚ùå No ResourceMetrics entries found"
          fi

          echo "  ‚û§ Checking for number data points presence..."
          if kubectl logs "$COLLECTOR_POD" | grep -q "NumberDataPoints"; then
            echo "    ‚úÖ Found NumberDataPoints entries"
            METRICS_FOUND=$((METRICS_FOUND + 1))
          else
            echo "    ‚ùå NumberDataPoints entries not found"
          fi

          echo "  ‚û§ Checking for OTLP scope name from telemetrygen..."
          if kubectl logs "$COLLECTOR_POD" | grep -qi "telemetrygen-metrics"; then
            echo "    ‚úÖ Found telemetrygen-metrics scope"
            METRICS_FOUND=$((METRICS_FOUND + 1))
          else
            echo "    ‚ùå telemetrygen-metrics scope not found"
          fi

          echo ""
          echo "üìä Verification Results:"
          echo "  ‚Ä¢ Metrics found: $METRICS_FOUND/4"

          # Check if we found enough metrics
          if [ "$METRICS_FOUND" -ge 3 ]; then
            echo "  ‚Ä¢ Status: ‚úÖ PASS - Telemetrygen metrics received via Remote Write v2"
            echo ""
            echo "üìù Sample entries from collector logs:"
            kubectl logs "$COLLECTOR_POD" | grep -A 5 -B 5 -i "telemetrygen" | head -20
          else
            echo "  ‚Ä¢ Status: ‚ùå FAIL - Not enough telemetrygen metrics found"
            echo ""
            echo "üîç Recent collector logs:"
            kubectl logs "$COLLECTOR_POD" --tail=50
            exit 1
          fi

          # Check for any error messages
          echo ""
          echo "üîç Checking for Remote Write v2 protocol errors..."
          if kubectl logs "$COLLECTOR_POD" | grep -i "remote.*write.*error\|protocol.*error\|version.*error"; then
            echo "‚ùó Found potential protocol errors:"
            kubectl logs "$COLLECTOR_POD" | grep -i "remote.*write.*error\|protocol.*error\|version.*error"
          else
            echo "‚úÖ No Remote Write protocol errors found"
          fi

          echo ""
          echo "üéâ Remote Write v2 verification completed successfully!"

      serviceAccountName: check-metrics-sa
  backoffLimit: 2
  activeDeadlineSeconds: 180